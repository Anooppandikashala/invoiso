name: Build and Release Invoiso

on:
  push:
    tags:
      - "v*"

# Required so GITHUB_TOKEN can create releases and upload assets
permissions:
  contents: write

jobs:
  # ─────────────────────────────────────────────────────────────
  # Windows — build .exe installer
  # ─────────────────────────────────────────────────────────────
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          cache: true

      - name: Set version from tag
        shell: bash
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION="${VERSION#v}"
          sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml
          echo "Building version: $VERSION"

      - name: Install FastForge
        run: dart pub global activate fastforge

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Build Flutter Windows Release
        run: flutter build windows --release

      - name: Build Windows Installer with FastForge
        run: fastforge package --platform windows --targets exe

      - name: Verify installer exists
        shell: bash
        run: |
          count=$(find dist -name "invoiso-*-windows-setup.exe" | wc -l)
          if [ "$count" -eq 0 ]; then
            echo "ERROR: No installer found in dist/"
            find dist -type f
            exit 1
          fi
          echo "Found installer(s):"
          find dist -name "invoiso-*-windows-setup.exe"

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: Invoiso-Windows-Installer
          path: dist/*/invoiso-*-windows-setup.exe

  # ─────────────────────────────────────────────────────────────
  # Linux — build .deb package
  # ─────────────────────────────────────────────────────────────
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          cache: true

      - name: Setup build dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev patchelf squashfs-tools

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION="${VERSION#v}"
          sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml
          echo "Building version: $VERSION"

      - name: Install FastForge
        run: dart pub global activate fastforge

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Build Flutter Linux Release
        run: flutter build linux --release

      - name: Build .deb Package
        run: |
          fastforge package --platform linux --targets deb
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION="${VERSION#v}"
          DEB_FILE=$(find dist/$VERSION -name "*.deb" | head -1)
          echo "Found deb: $DEB_FILE"
          mv "$DEB_FILE" Invoiso-$VERSION-ubuntu22.deb

      - name: Upload .deb
        uses: actions/upload-artifact@v4
        with:
          name: Invoiso-Ubuntu22.deb
          path: Invoiso-*-ubuntu22.deb

  # ─────────────────────────────────────────────────────────────
  # Linux — build AppImage
  # ─────────────────────────────────────────────────────────────
  build-appimage:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          cache: true

      - name: Setup build dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev patchelf squashfs-tools

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION="${VERSION#v}"
          sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml
          echo "Building version: $VERSION"

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Build Flutter Linux Release
        run: flutter build linux --release

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          mkdir -p AppDir/usr/share/icons
          cp assets/deb/images/logo.png AppDir/usr/share/icons/logo.png

      - name: Install AppImage Builder
        run: |
          sudo apt-get install -y appstream file desktop-file-utils libfuse2 zsync
          pip install appimage-builder==1.1.0

      - name: Build AppImage
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION="${VERSION#v}"
          sed -i "/app_info:/,/^[^ ]/ s/^\(\s*version:\s*\)[0-9.]*$/\1$VERSION/" AppImageBuilder.yml
          appimage-builder --recipe AppImageBuilder.yml --skip-test

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: Invoiso-AppImage
          path: "*.AppImage"

  # ─────────────────────────────────────────────────────────────
  # Release — collect artifacts and publish GitHub Release
  # Runs only after all three build jobs succeed
  # ─────────────────────────────────────────────────────────────
  create-release:
    needs: [build-windows, build-linux, build-appimage]
    runs-on: ubuntu-latest

    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: Invoiso-Windows-Installer
          path: release-assets/

      - name: Download Ubuntu22 .deb
        uses: actions/download-artifact@v4
        with:
          name: Invoiso-Ubuntu22.deb
          path: release-assets/

      - name: Download AppImage
        uses: actions/download-artifact@v4
        with:
          name: Invoiso-AppImage
          path: release-assets/

      - name: List release assets
        run: find release-assets -type f

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Invoiso ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: release-assets/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
